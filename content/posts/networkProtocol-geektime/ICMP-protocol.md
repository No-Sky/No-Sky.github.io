---
title: "ICMP&Ping"
author: "nosky"
date: 2019-11-22T16:40:52+08:00
draft: false
tags: ["Network Protocol"]
---

# ICMP协议的格式

ping 是基于 ICMP 协议工作的。ICMP全称Internet Control Message Protocol，就是互联网控制报文
协议。
ICMP 报文是封装在 IP 包里面的。因为传输指令的时候，肯定需要源地址和目标地址。它本身非常简
单。ICMP 报文有很多的类型，不同的类型有不同的代码。最常用的类型是主动请求为 8，主动请求的应答为
0。

## 查询报文类型

常用的ping 就是查询报文，是一种主动请求，并且获得主动应答的 ICMP 协议。所以，ping 发的包也是符合 ICMP 协议格式的，只不过它在后面增加了自己的格式。对 ping 的主动请求，进行网络抓包，称为ICMP ECHO REQUEST。同理主动请求的回复，称为ICMPECHO REPLY。比起原生的 ICMP，这里面多了两个字段，一个是标识符。在选项数据中，ping 还会存放发送请求的时间值，来计算往返时间，说明路程的长短。

## 差错报文类型

几个 ICMP 差错报文的例子：终点不可达为 3，源抑制为 4，超时为 11，重定向为 5。
第一种是终点不可达。具体的原因在代码中表示就是，网络不可达代码为 0，主机
不可达代码为 1，协议不可达代码为 2，端口不可达代码为 3，需要进行分片但设置了不分片位代码为
4。
第二种是源站抑制，也就是让源站放慢发送速度。
第三种是时间超时，也就是超过网络包的生存时间还是没到。
第四种是路由重定向，也就是让下次发给另一个路由器。
差错报文的结构相对复杂一些。除了前面还是 IP，ICMP 的前 8 字节不变，后面则跟上出错的那个 IP 包
的 IP 头和 IP 正文的前 8 个字节。

  