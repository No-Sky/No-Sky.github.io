---
title: "TCP协议"
author: "nosky"
date: 2019-11-22T16:40:52+08:00
draft: false
tags: ["Network Protocol"]
---

# TCP协议

 TCP协议作为传输层主要协议之一，具有面向连接，端到端，可靠的全双工通信，面向字节流的数据传输协议。 

### 1、TCP报文段

虽然TCP面向字节流，但TCP传输的数据单元却是报文段。TCP报文段分为TCP首部和数据部分，TCP报文段首部的前20个字节是固定的，后面有4*n字节根据需要动态添加的选项，最大长度为40字节。 

![img](/posts/networkProtocol-geektime/TCP-Layer.assets/16bea56ed5a68bb6)

- **源端口和目的端口** 各占两个字节，TCP的分用功能也是通过端口实现的。
- **序号** 占4个字节，范围是[0,232],TCP是面向字节流的，每个字节都是按顺序编号。例如一个报文段，序号字段是201，携带数据长度是100，那么第一个数据的序号就是201，最后一个就是300。当达到最大范围，又从0开始。
- **确认号** 占4个字节，是期望收到对方下一个报文段的第一个字节的序号。若确认号=N,则表示序号N前所有的数据已经正确收到了。
- **数据偏移** 占4位，表示报文段的数据部分的起始位置，距离整个报文段的起始位置的距离。间接的指出首部的长度。
- **保留** 占6位，保留使用，目前为0.
- **URG（紧急）** 当URG=1,表明紧急指针字段有效，该报文段有紧急数据，应尽快发送。
- **ACK(确认)** 仅当ACK=1时，确认号才有效，连接建立后，所有的报文段ACK都为1。
- **PSH(推送)** 接收方接收到PSH=1的报文段，会尽快交付接收应用经常，不再等待整个缓存填满再交付。实际较少使用。
- **RST(复位)** RST=1时，表明TCP连接中出现严重差错，必须是否连接，再重连。
- **SYN(同步)** 在建立连接时用来同步序号。当SYN=1,ACK=0，则表明是一个连接请求报文段。SYN=1,ACK=1则表示对方同意连接。TCP建立连接用到。
- **FIN(终止)** 用来释放一个连接窗口。当FIN=1时，表明此报文段的发送方不再发送数据，请求释放单向连接。TCP断开连接用到。
- **窗口** 占2个字节，表示发送方自己的接收窗口，窗口值用来告诉对方允许发送的数据量。
- **校验和** 占2字节，检验和字段查验范围包括首部和数据部分。
- **紧急指针** 占2字节，URG=1时，紧急指针指出本报文段中的紧急数据的字节数（紧急字节数结束后为普通字节）。
- **选项** 长度可变，最长可达40字节。例如最大报文段长度MSS。MSS指的是数据部分的长度而不是整个TCP报文段长度，MSS默认为536字节长。窗口扩大，时间戳选项等。

### 2、TCP建立连接-三次握手

三次握手图例如下,与文字解释配合使用效果更佳。



![img](/posts/networkProtocol-geektime/TCP-Layer.assets/16b98a433dbbc569)

**第一次**：客户端发送连接请求报文给服务端，其中SYN=1,seq=x。发送完毕后进入SYN_END状态。

**第二次**：服务端接收到报文后，发回确认报文，其中ACK=1,ack=x+1，因为需要客户端确认，所以报文中也有SYN=1,seq=y的信息。发送完后进入SYN_RCVD状态。

**第三次**:客户端接收到报文后,发送确认报文，其中ACK=1,ack=y+1。发送完客户端进入`ESTABLISHED`状态，服务端接收到报文后，进入`ESTABLISHED`状态。到此，连接建立完成。

**三次握手原因**

避免资源被浪费掉。如果在第二步握手时，由于网络延迟导致确认包不能及时到达客户端，那么客户端会认为第一次握手失败，再次发送连接请求，服务端收到后再次发送确认包。在这种情况下，服务端已经创建了两次连接，等待两个客户端发送数据，而实际却只有一个客户端发送数据。

### 3、TCP断开连接-四次挥手

四次挥手指客户端和服务端各发送一次请求终止连接的报文，同时双方响应彼此的请求。 四次挥手图例如下，请配置文字解释使用哦。 

![四次挥手图例](/posts/networkProtocol-geektime/TCP-Layer.assets/16b988e39a5f0821)

**第一次挥手**：客户端发送FIN=1，seq=x的包给服务端，表示自己没有数据要进行传输，单面连接传输要关闭。发送完后，客户端进入状态。

**第二次挥手**：服务端收到请求包后，发回ACK=1,ack=x+1的确认包，表示确认断开连接。服务端进`入CLOSE_WAIT`状态。客户端收到该包后，进入`FIN_WAIT_2`状态。此时客户端到服务端的数据连接已断开。

**第三次挥手**：服务端发送FIN=1,seq=y的包给客户端，表示自己没有数据要给客户端了。发送完后进入`LAST_ACK`状态，等待客户端的确认包。

**第四次挥手**：客户端收到请求包后，发送ACK=1,ack=y+1的确认包给服务端，并进入`TIME_WAIT`状态，有可能要重传确认包。服务端收到确认包后，进入`CLOSED`状态，服务端到客户端的连接已断开。客户端等到一段时间后也会进入`CLOSED`状态。

**四次挥手原因** 由于TCP的连接是全双工，双方都可以主动传输数据，一方的断开需要告知对方，让对方可以相关操作，负责任的表现。

使用TCP协议有：FTP（文件传输协议）、Telnet（远程登录协议）、SMTP（简单邮件传输协议）、POP3（和SMTP相对，用于接收邮件）、HTTP协议等